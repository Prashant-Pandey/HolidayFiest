function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();define("platformInit/utils/appsUtils",["lodash"],function(e){"use strict";function t(t,r){return e(r).map(function(e){return t.getDynamicPageData(e)}).find()}function r(r,n,i){if(r){var a=t(r,i);if(a){var o=a.routerData,s=a.routerDefinition;if(o&&s)if("wix-code"===s.appDefinitionId)e.forEach(i,function(t){e.forEach(n,function(e){e.id===t&&(e.routerData=o)})});else{var u=e.find(n,{id:s.appDefinitionId});u&&(u.routerData=o)}}}}function n(t){return e(t).reject({displayName:"siteextension"}).map(function(t){return e.assign({type:h.APPLICATION},t)}).value()}function i(t){return!!e.get(t,["wixCodeModel","appData","codeAppId"])}function a(t){return e.some(t.widgets,{componentFields:{semiNative:!0}})}function o(t,r,n,a,o){if(i(a.rendererModel)&&e.find(t,r)){var s=a.isPlatformAppOnPage("masterPage","wixCode");e.forEach(n,function(t){var r=a.isPlatformAppOnPage(t,"wixCode"),n=a.getDataByQuery(t),i=e.get(n,"isPopup");r&&o.push({id:t,type:i?h.POPUP:h.PAGE,displayName:a.getPageTitle(t)}),!i&&s&&o.push({id:t,type:h.MASTER_PAGE})})}}function s(t,i,a){t=e.without(t,"masterPage");var s=n(a);return o(a,{displayName:"siteextension"},t,i,s),r(i,s,t),s}function u(){for(var e=arguments[0],t=1;t<arguments.length;++t)e=e.replace(/\/$/,"")+"/"+arguments[t].replace(/^\//,"");return e}function c(e,t,r){var n=u(e.scriptsDomainUrl,"services",t);return r?u(n,r):e.scriptsLocationMap[t]}function d(t,r,n){if(e.get(t,"port")&&e.get(t,"path")&&e.get(t,"id")){n=e.endsWith(n,"/")?n.slice(0,-1):n;var i=e.template("<%= santaBase %><%= port %>/<%= path %>"),a=void 0;a=/^(http(s)?:)?\/\//.test(t.path)?t.path:i("80"===t.port?{santaBase:n,port:"",path:t.path}:{santaBase:n,port:":"+t.port,path:t.path}),r.push({type:h.APPLICATION,id:t.id,url:a,displayName:t.id})}}function l(t,r,n,a,o){i(o)&&e.find(t,{type:"siteextension"})&&!e.find(r,{id:"dataBinding"})&&r.push({type:h.APPLICATION,id:"dataBinding",url:u(c(n,"dbsm-viewer-app",a.dataBinding),"/app.js"),hasSemiNativeWidgets:!1,displayName:"Data Binding"})}function p(t,r){return e(t).filter(function(t){return i(r)&&"siteextension"===t.type||e.has(t,"appFields.platform.viewerScriptUrl")}).map(function(t){var r={id:t.appDefinitionId,displayName:t.type,appInnerId:t.applicationId,instance:t.instance},n=e.get(t,"appFields.platform.viewerScriptUrl");return n&&(r.url=n),r.hasSemiNativeWidgets=a(t),r}).value()}function f(e){var t=p(e.clientSpecMap,e.rendererModel),r=m(e.viewerPlatformAppSources);return d(r,t,e.santaBase),l(e.clientSpecMap,t,e.serviceTopology,r,e.rendererModel),t}function g(t,r,n){return s(r,n,f({clientSpecMap:t,viewerPlatformAppSources:e.get(n,["currentUrl","query","viewerPlatformAppSources"]),serviceTopology:n.serviceTopology,santaBase:n.santaBase,rendererModel:n.rendererModel}))}function m(t){return e(t||"").split(",").invokeMap("split",/:(.+)/).fromPairs().value()}var h={POPUP:"Popup",PAGE:"Page",MASTER_PAGE:"masterPage",APPLICATION:"Application"};return{getApplications:g,getUserCodeDefinitions:function(t,r,n){return e.reject(g(t,r,n),{type:h.APPLICATION})},getAppsBaseInfo:function(t){var r=f(t);return e.filter(n(r),"url")}}}),define("platformInit/utils/widgetsPreLoader",["platformInit/utils/appsUtils"],function(e){"use strict";function t(e,t,u,c){if(n())return s.push([e,t,u,c]),void requirejs(["utils","widgets","wixCode"],r);var d=c(i);d.currentUrl=i.urlUtils.parseUrl(e);var l=i.wixUrlParser.parseUrl(d,e),p=l&&l.pageId;if(p){var f=t(a,d,p),g=o.wixCodeWidgetService.getWixCodeSpec(d.getClientSpecMap());u(o.messageBuilder.getExtendedMessage(f,d.rendererModel.wixCodeModel||{},g,d))}}function r(e,r,u){n()&&(i=e,a=r,o=u,s.forEach(function(e){return t.apply(void 0,_toConsumableArray(e))}),s.length=0)}function n(){return!i||!a||!o}var i=null,a=null,o=null,s=[];return{asyncGetPreLoadMessage:function(r,n,i){t(n,function(t,n,i){var a=e.getApplications(r.rendererModel.clientSpecMap,[i],n),o=r.routers||{configMap:{}};return t.messageBuilder.loadWidgetsMessage(a,o.configMap,[i])},i,function(e){return new e.FullSiteData(r,function(){})})},asyncGetPreLoadUserCodeMessage:function(r,n,i){t(n,function(t,n,i){var a=e.getUserCodeDefinitions(r.rendererModel.clientSpecMap,[i],n);return t.messageBuilder.loadUserCodesMessage(a,[i])},i,function(e){return new e.FullSiteData(r,function(){})})},asyncGetPreInitMessage:function(e,r,n){t(r,function(e,t,r){var n={};return n[r]=e.widgetService.getContextInitData(t,r),e.messageBuilder.initWidgetsMessage(n)},n,function(){return e})},registerDeps:r}}),define("platformInit/utils/constants",[],function(){"use strict";return{APPS:{SANTA_MEMBERS:{appDefId:"14cc59bc-f0b7-15b8-e1c7-89ce41d0e0c9"},FORM_BUILDER:{appDefId:"14ce1214-b278-a7e4-1373-00cebd1bef7c"}},ES6_RUNTIME_PATH:"/es6runtime.min.js",WIX_CODE_RUNTIME_PATH:"/all.min.js",DATA_BINDING:"dataBinding",REMOTE_DOM_URL:"//unpkg.parastorage.com/@shimil/remote-dom@3.0.3/dist/remote.min.js",SEMI_NATIVE_SDK_URL:"http://static.parastorage.com/services/semi-native-sdk/1.3.0/lib/wix.min.js"}}),define("platformInit/utils/wixCodeUrlUtils",["lodash"],function(e){"use strict";function t(e){var t=e.appConfig.userScript;return{id:e.id,url:t.url,scriptName:t.scriptName,displayName:t.displayName,routerData:e.routerData}}function r(t){return e(t).map("appConfig").find()}function n(t){return e.reduce(t,function(t,r,n){return e.isUndefined(r)?t:t.concat([n+"="+r])},[]).join("&")}function i(t,r){return t.publicModel?"/_api/wix-code-public-dispatcher/siteview":"//"+e.find(r,{type:"siteextension"}).instanceId+".dev."+t.serviceTopology.wixCloudBaseDomain}return{getUserCodeUrlsDetails:function(r,n){var i=[],a=e.find(r,function(e){return e.id===n&&"masterPage"!==e.type}),o=e.find(r,{id:n,type:"masterPage"});return o&&i.push(t(o)),a&&i.push(t(a)),i},getElementoryArguments:function(e,t,a,o){var s=r(a);if(s)return{baseUrl:i(e,t),queryParameters:n({scari:s.scari,instance:s.instance,viewMode:o})}}}}),define("platformInit/utils/urlBuilder",["lodash"],function(e){"use strict";function t(e){return e&&e.replace(/^https?\:/,"")}function r(r,n){var i=t(r);if(e.startsWith(i,n)){var a=i.slice(n.length).match(/\/?services\/santa\/([\w.]+)/);return a&&a[1]}}function n(e,n,i,a){if(e)return e;var o=t(a);return r(n,o)||r(i,o)}return{buildUrl:function(e,t){var r=t.runtimeSource,i=e.serviceTopology;return"/_partials/santa/"+n(r,e.santaBase,i.scriptsLocationMap.santa,i.scriptsDomainUrl)+"/node_modules/santa-wix-code/dist/wixcode-worker.js"}}}),define("platformInit/utils/FallbackStorage",[],function(){"use strict";return function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"setItem",value:function(e,t){this[e]=String(t)}},{key:"getItem",value:function(e){return this[e]||null}},{key:"removeItem",value:function(e){delete this[e]}},{key:"clear",value:function(){var e=this;Object.keys(this).forEach(function(t){return e.removeItem(t)})}},{key:"toJSON",value:function(){return this.storage.toJSON()}}]),e}()}),define("platformInit/utils/storageFacade",["lodash","platformInit/utils/FallbackStorage"],function(e,t){"use strict";function r(t){return e(t).pickBy(function(t,r){return e.startsWith(r,n)}).reduce(function(t,r,i){return e.assign(t,_defineProperty({},i.replace(n,""),r))},{})}var n="platform_app_";return{get:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0]?window:{localStorage:new t,sessionStorage:new t};return{serialize:function(){return JSON.stringify({local:r(e.localStorage),session:r(e.sessionStorage)})},setItem:function(t,r,i){e[t].setItem(n+r,i)}}}}}),define("platformInit/utils/messageBuilder",[],function(){"use strict";return{bootstrapMessage:function(e){return{type:"wix_code_worker_bootstrap",bootstrapArguments:e}},loadUserCodeMessage:function(e,t){return{type:"wix_code_worker_load_user_code",workerId:e,wixCode:t}},loadMessage:function(e,t,r,n,i,a,o,s){return{type:"wix_code_worker_load",workerId:e,elementoryArguments:t,wixCode:r,applications:n,sdkParameters:i,routersMap:a,lightboxContext:o,storage:s}},initMessage:function(e,t){return{type:"wix_code_worker_init",id:e,apps:t}},startMessage:function(e,t,r){return{type:"wix_code_worker_start",context:e,id:t,siteInfo:r}},storageWasUpdatedMessage:function(e){return{type:"storageWasUpdated",storageValue:e}},updateWixCodeModelDataAfterLoginMessage:function(e,t){return{type:"update_wix_code_model_data_after_login",workerId:e,elementoryArguments:t}}}}),define("platformInit/api/workerManager",["lodash","platformInit/utils/constants","platformInit/utils/wixCodeUrlUtils","platformInit/utils/urlBuilder","platformInit/utils/storageFacade","platformInit/utils/messageBuilder"],function(e,t,r,n,i,a){"use strict";function o(e){return e.publicModel?"site":e.renderFlags.componentViewMode||"preview"}function s(){return{viewMode:o(this._siteModel),locale:this._siteModel.rendererModel.languageCode,storage:this._storageManager.serialize()}}function u(e){e.forEach(function(e){document.getElementById(e.id)||function(){var t=document.createElement("link");t.rel="prefetch",t.href=e.url,t.id=e.id,document.body.appendChild(t)}()})}function c(){if(!this._standbyWorker){var e=new Worker(n.buildUrl(this._siteModel,this._options));e.onmessage=this.onmessage,this._standbyWorker=e,d.call(this,e)}}function d(){var e=this._options.applications,r=this._siteModel.serviceTopology.scriptsLocationMap["wix-code-platform"],n={id:"es6runtime",url:r+t.ES6_RUNTIME_PATH},i={id:"wixCodeRuntime",url:r+t.WIX_CODE_RUNTIME_PATH},o={id:"sdk",url:this._options.sdkSource},c={id:"semi-native-sdk",url:this._options.semiNativeSDKSource},d=this._options.ReactLibSource,l=this._options.ReactDomSource;u(e.concat([n,i,o])),this._standbyWorker.postMessage(a.bootstrapMessage({sdkParameters:s.call(this),debug:window.__WIX_CODE_DEBUG__,sdkSource:o.url,semiNativeSDKSource:c.url,reactDomSource:l,reactSource:d,applications:encodeURIComponent(JSON.stringify(e)),wixCodeScripts:[n,i]}))}function l(e){this._workers[e]=this._standbyWorker,this._reportWorkerCreated(e),this._standbyWorker=null}function p(t,n){return t.reduce(function(t,i){return e.assign(t,_defineProperty({},i,r.getUserCodeUrlsDetails(n,i)))},{})}function f(e){var t=this;Object.keys(e).forEach(function(r){var n=e[r];u(n),t.has(r)||(c.call(t),l.call(t,r)),t.send(r,a.loadUserCodeMessage(r,n))})}function g(e){var t=this._workers[e];return!!t&&(t.terminate(),delete this._workers[e],!0)}function m(e){var t=this,r=e.applications,n=e.rootIds,i=e.wixCodeScriptsByRootId,o=e.elementoryArguments,s=e.popupContexts,u=e.routersMap,d=e.sdkParameters;n.forEach(function(e){t.has(e)||(c.call(t),l.call(t,e)),t.send(e,a.loadMessage(e,o,i[e],r,d,u,s[e],t._storageManager.serialize()))})}function h(t){var r=this,n=t.type,i=t.key,o=t.value;this._storageManager.setItem(n,i,o);var s=a.storageWasUpdatedMessage(this._storageManager.serialize());e.forEach(this._workers,function(e,t){r.send(t,s)})}function M(t){var r=this;return function(n){var i=n.data;e.isMatch(i,{intent:"BROWSER_API",type:"setToStorage"})&&h.call(r,i.data),t(i)}}var _=function(){function t(e,r,n,i){_classCallCheck(this,t),this._siteModel=e,this._clientSpecMap=r,this._options=i,this._workers={},this._standbyWorker=null,this._storageManager=n}return _createClass(t,[{key:"has",value:function(e){return Boolean(this._workers[e])}},{key:"initialize",value:function(e,t,r){this.onmessage=M.call(this,e),this._reportWorkerCreated=t,this._reportWorkerTerminated=r,c.call(this)}},{key:"send",value:function(e,t,r){var n=this._workers[e];n&&(r?n.postMessage(t,r):n.postMessage(t))}},{key:"get",value:function(e){return this._workers[e]}},{key:"handleWidgetsCommand",value:function(t){var n=this;switch(t.type){case"load_user_code":f.call(this,p(t.rootIds,t.widgets));break;case"load_widgets":m.call(this,{applications:e.reject(t.widgets,e.overSome({type:"Page"},{type:"Popup"},{type:"masterPage"})),rootIds:t.rootIds,wixCodeScriptsByRootId:p(t.rootIds,t.widgets),elementoryArguments:r.getElementoryArguments(this._siteModel,this._clientSpecMap,t.widgets,o(this._siteModel)),popupContexts:t.popupContexts,routersMap:t.routersMap,sdkParameters:t.sdkParameters});break;case"init_widgets":e.forEach(t.contexts,function(e,t){if(!n.has(t))throw new Error("Context id "+t+" is not loaded");n.send(t,a.initMessage(t,e))});break;case"start_widgets":if(!t.contexts)throw new Error("Start message must contain contexts property");e.forEach(t.contexts,function(e,r){if(!n.has(r))throw new Error("Context id "+r+" is not loaded");n.send(r,a.startMessage(e,r,t.siteInfo))});break;case"trigger_onRender":c.call(this),this.send(t.contextId,t);break;case"stop_widgets":e.forEach(t.widgetIds,function(e){g.call(n,e)&&n._reportWorkerTerminated(e)});break;case"update_wix_code_model_data_after_login":e.forEach(t.rootIds,function(e){n.send(e,a.updateWixCodeModelDataAfterLoginMessage(e,r.getElementoryArguments(n._siteModel,n._clientSpecMap,t.widgets,o(n._siteModel))))});break;default:this.has(t.contextId)&&this.send(t.contextId,t)}}}]),t}();return{getWorkerManager:function(e,t,r,n){return new _(e,t,i.get(r),n)}}}),define("platformInit/utils/messageProxy",[],function(){"use strict";return{get:function(){var e=[],t=null;return{sendOrHoldMessage:function(r){t?t(r):e.push(r)},setMessageHandler:function(r){for(t=r;e.length>0;)t(e.shift())}}}}}),define("platformInit/bi/events.json",[],function(){return{WORKER_CREATED:{src:79,eventId:101,params:{worker_id:"worker_id"}},WORKER_TERMINATED:{src:79,eventId:102,params:{worker_id:"worker_id"}}}}),define("platformInit/api/wixCodeAppApi",["lodash","platformInit/utils/widgetsPreLoader","platformInit/api/workerManager","platformInit/utils/messageProxy","platformInit/bi/events.json"],function(e,t,r,n,i){"use strict";function a(t){var r=t.rendererModel.clientSpecMap.toJS?t.rendererModel.clientSpecMap.toJS():t.rendererModel.clientSpecMap;return t.rendererModel.wixCodeModel&&e.some(r,{type:"siteextension"})}function o(){try{return window.localStorage.setItem("",""),window.localStorage.removeItem(""),!0}catch(e){return!1}}function s(e,t){return{data:{intent:"WIX_CODE_SITE_API",type:"reportBI",reportDef:e,params:t}}}return{getApi:function(){function u(e){d(s(i.WORKER_CREATED,{worker_id:e}))}function c(e){d(s(i.WORKER_TERMINATED,{worker_id:e}))}function d(e){f.forEach(function(t){t(e)})}function l(e){return g.reduce(function(e,t){return t(e)},e)}var p=n.get(),f=[],g=[],m=!1,h=!1,M=!1,_=!1,w=void 0,v=void 0;return{init:function(e,t,n){m?console.warn("Wix code is already initiated"):(v=n.applications.length>0,(a(e)||v)&&((w=r.getWorkerManager(e,t,o(),n)).initialize(d,u,c),p.setMessageHandler(function(e){return w.handleWidgetsCommand(e)}),m=!0))},sendMessage:function(e){e&&p.sendOrHoldMessage(l(e))},registerMessageHandler:function(e){f.push(e)},registerMessageModifier:function(e){g.push(e)},unregisterMessageHandler:function(t){e.pull(f,t)},preLoadWidgets:function(e,r){!h&&a(e)&&t.asyncGetPreLoadMessage(e,r,function(e){h||(h=!0,p.sendOrHoldMessage(e))})},preLoadUserCode:function(e,r){(!M&&a(e)||v)&&t.asyncGetPreLoadUserCodeMessage(e,r,function(e){M||(M=!0,p.sendOrHoldMessage(e))})},preInitWidgets:function(e,r){!_&&a(e)&&t.asyncGetPreInitMessage(e,r,function(e){_||(_=!0,p.sendOrHoldMessage(e))})},isAppInitiated:function(){return m},getWorkerById:function(e){return w&&w.get(e)}}}}}),define("platformInit/api/initMainR",["lodash","platformInit/utils/appsUtils"],function(e,t){"use strict";var r="//unpkg.parastorage.com/react@16/umd/react",n="//unpkg.parastorage.com/react-dom@16/umd/react-dom";return function(i,a,o,s,u,c,d,l){function p(t){return e.some(t,{type:"siteextension"})||_.applications.length}c=c||window.document.location.href;var f=e.trimEnd(o.serviceTopology.scriptsLocationMap["js-wixcode-sdk"],"/")+"/lib/"+(u.getParameterByName("debug")?"wix.js":"wix.min.js"),g=e.trimEnd(o.serviceTopology.scriptsLocationMap["semi-native-sdk"],"/")+"/lib/"+(u.getParameterByName("debug")?"wix.js":"wix.min.js"),m=function(e){return"false"!==e&&("true"===e||!window.Worker||d)}(u.getParameterByName("useWixCodeFallback")),h=r+(u.getParameterByName("debug")?".development.js":".production.min.js"),M=n+(u.getParameterByName("debug")?".development.js":".production.min.js"),_={isMobileView:s,sdkSource:f,semiNativeSDKSource:g,runtimeSource:u.getParameterByName("WixCodeRuntimeSource"),ReactLibSource:h,ReactDomSource:M,useWixCodeFallback:m},w=u.getParameterByName("viewerPlatformAppSources");_.applications=t.getAppsBaseInfo({rendererModel:o.rendererModel,clientSpecMap:o.rendererModel.clientSpecMap,serviceTopology:o.serviceTopology,viewerPlatformAppSources:w,santaBase:o.santaBase}),function(e,t){o.publicModel&&l||(i.init(o,e,_),p(e)&&(i.preLoadUserCode(o,c),!!o.publicModel&&i.preLoadWidgets(o,c)))}(o.rendererModel.clientSpecMap)}}),define("platformInit/utils/specMapUtils",["lodash"],function(e){"use strict";return{getAppSpec:function(t){return e.find(t,{type:"siteextension"})}}}),define("platformInit",["platformInit/api/wixCodeAppApi","platformInit/api/initMainR","platformInit/utils/specMapUtils","platformInit/utils/appsUtils","platformInit/utils/widgetsPreLoader"],function(e,t,r,n,i){"use strict";return{getAppApi:e.getApi,initMainR:t,specMapUtils:r,appsUtils:n,registerDeps:i.registerDeps}});
//# sourceMappingURL=platformInit.min.js.map